<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin Streaming Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .file-input-wrapper input[type="text"] {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .browse-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
        }

        .browse-btn:hover {
            background: #2980b9;
        }

        .scan-button {
            padding: 12px 25px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .scan-button:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .scan-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: rgba(52, 73, 94, 0.1);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 35%, 
                rgba(255,255,255,0.2) 35%, 
                rgba(255,255,255,0.2) 65%, 
                transparent 65%);
            background-size: 20px 20px;
            animation: progressAnimation 1s linear infinite;
        }

        @keyframes progressAnimation {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-percentage {
            color: #3498db;
            font-size: 1.2rem;
        }

        .current-file {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .progress-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .progress-stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .stats {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid;
        }

        .stat-card:nth-child(1) { border-left-color: #3498db; }
        .stat-card:nth-child(2) { border-left-color: #27ae60; }
        .stat-card:nth-child(3) { border-left-color: #e74c3c; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .filters {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .display-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(52, 73, 94, 0.05);
            border-radius: 8px;
        }

        .view-toggle {
            display: flex;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .view-toggle button {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-toggle button.active {
            background: #3498db;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #ecf0f1;
        }

        .field-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .field-filter {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .field-filter input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .rating-range-container {
            position: relative;
            width: 100%;
            min-width: 250px;
        }

        .rating-range {
            position: relative;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin: 15px 0;
        }

        .rating-range-fill {
            position: absolute;
            height: 100%;
            background: #3498db;
            border-radius: 4px;
        }

        .rating-input {
            position: absolute;
            width: 100%;
            height: 8px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .rating-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            pointer-events: all;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .rating-input::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            pointer-events: all;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .rating-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 8px;
            font-weight: 600;
        }

        .streaming-services-config {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .service-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }

        .service-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .movies-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .provider-icon {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 3px;
            display: inline-block;
            vertical-align: middle;
            object-fit: cover;
        }

        .movie-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: #fff;
            aspect-ratio: 2/3;
            cursor: pointer;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .movie-poster {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .movie-poster img {
            /* width: 100%; */
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .movie-card:hover .movie-poster img {
            transform: scale(1.05);
        }

        .movie-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 20px 15px 15px;
            color: white;
        }

        .movie-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .movie-filename {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .movie-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .rating-badge {
            background: rgba(255,193,7,0.9);
            color: #000;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .streaming-providers {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            align-items: center;
        }

        .no-streaming {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }

        .movie-card-list {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .movie-card-list:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .movie-poster-list {
            width: 80px;
            height: 120px;
            flex-shrink: 0;
        }

        .movie-poster-list img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-info-list {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .movie-header-list {
            margin-bottom: 10px;
        }

        .movie-title-list {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .movie-filename-list {
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .movie-details-list {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .movie-year-list {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .rating-badge-list {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .no-poster {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ecf0f1;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .provider-badge {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 25px;
        }

        .modal-poster img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .modal-info h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .modal-overview {
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
        }

        .modal-providers {
            margin-bottom: 20px;
        }

        .modal-providers h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal-details {
            display: grid;
            gap: 10px;
        }

        .detail-item {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .detail-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .detail-value {
            color: #2c3e50;
        }

        .modal-links {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tmdb-link {
            background: #01b4e4;
            color: white;
        }

        .trailer-link {
            background: #e74c3c;
            color: white;
        }

        .modal-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover,
        .close:focus {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
            }

            .file-input-wrapper {
                min-width: auto;
            }

            .movies-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-body {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .display-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .field-filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Jellyfin Streaming Dashboard</h1>
            <p>D√©couvrez quels films de votre collection sont disponibles sur les plateformes de streaming</p>
        </div>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="text" id="movieDirectory" placeholder="S√©lectionnez un dossier contenant vos films..." readonly>
                <input type="file" id="directoryPicker" webkitdirectory directory multiple onchange="handleDirectorySelect()" style="display: none;">
                <button class="browse-btn" onclick="document.getElementById('directoryPicker').click()">
                    üìÅ Parcourir
                </button>
            </div>
            <button class="scan-button" onclick="scanMovies()">
                üîç Scanner la biblioth√®que
            </button>
        </div>

        <div id="loading">
            <div class="progress-container">
                <div class="progress-text">
                    <span>Analyse de votre biblioth√®que en cours...</span>
                    <span class="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="current-file">Initialisation...</div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value">0</div>
                        <div class="progress-stat-label">Films analys√©s</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">0</div>
                        <div class="progress-stat-label">Sur plateformes</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">0</div>
                        <div class="progress-stat-label">Non disponibles</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMovies">0</div>
                    <div class="stat-label">Films analys√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streamingMovies">0</div>
                    <div class="stat-label">Sur plateformes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="nonStreamingMovies">0</div>
                    <div class="stat-label">Non disponibles</div>
                </div>
            </div>
        </div>

        <div class="filters" id="filtersSection">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Affichage</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="showStreaming" checked onchange="applyFilters()">
                            Sur plateformes
                        </label>
                        <label>
                            <input type="checkbox" id="showNonStreaming" checked onchange="applyFilters()">
                            Non disponibles
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="sortBy">Trier par</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="title">Nom (A-Z)</option>
                        <option value="title-desc">Nom (Z-A)</option>
                        <option value="release_date">Date de sortie (‚Üë)</option>
                        <option value="release_date-desc">Date de sortie (‚Üì)</option>
                        <option value="vote_average">Note (‚Üë)</option>
                        <option value="vote_average-desc">Note (‚Üì)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterProvider">Service de streaming</label>
                    <select id="filterProvider" onchange="applyFilters()">
                        <option value="">Tous les services</option>
                        <option value="none">Aucun service</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterGenre">Genre</label>
                    <select id="filterGenre" onchange="applyFilters()">
                        <option value="">Tous les genres</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="moviesGrid" class="movies-grid"></div>
    </div>

    <!-- Modal pour les d√©tails du film -->
    <div id="movieModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-poster">
                    <img id="modalPoster" src="" alt="">
                </div>
                <div class="modal-info">
                    <p id="modalOverview"></p>
                    
                    <div class="modal-providers">
                        <h3>Plateformes de streaming</h3>
                        <div id="modalProviders"></div>
                    </div>
                    
                    <div id="modalDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration de l'API TheMovieDB
        const API_KEY = '8a622be4ecefaece7606f951e2e78808';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';

        // Variables globales
        let moviesData = [];
        let allMoviesData = [];
        let movieFiles = [];
        let currentView = 'grid';
        let showFields = {
            filename: true,
            rating: true,
            year: true,
            providers: true
        };
        let ratingRange = { min: 0, max: 10 };
        let selectedServices = ['Netflix', 'Amazon Prime Video', 'Apple TV Plus', 'Canal+'];
        let allGenres = [];

        // Fonction pour g√©rer la s√©lection de dossier
        function handleDirectorySelect() {
            const files = document.getElementById('directoryPicker').files;
            movieFiles = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.name.toLowerCase().endsWith('.mkv') ||
                    file.name.toLowerCase().endsWith('.mp4') ||
                    file.name.toLowerCase().endsWith('.avi')) {
                    movieFiles.push(file.name);
                }
            }
            console.log(`${movieFiles.length} fichiers vid√©o d√©tect√©s`);
            const directoryInput = document.getElementById('movieDirectory');
            directoryInput.value = `${movieFiles.length} films d√©tect√©s - Pr√™t √† scanner`;
        }

        // Fonction pour scanner un dossier local
        function scanLocalDirectory() {
            const directoryPath = document.getElementById('movieDirectory').value;
            if (movieFiles.length > 0) {
                return movieFiles;
            } else {
                return [];
            }
        }

        function detectMovieInfo(filename) {
            const yearMatch = filename.match(/\b(?:19|20)\d{2}\b/);
            if (yearMatch) {
                const year = yearMatch[0];
                let movieName = filename.split(year)[0].replace(/\./g, ' ').trim();
                movieName = movieName.replace(/\[.*?\]/g, '');
                return { movieName, year };
            }
            return { movieName: null, year: null };
        }

        // Fonction pour obtenir les informations du film depuis TheMovieDB
        async function getMovieInfo(movieName, year) {
            try {
                const response = await fetch(`${BASE_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(movieName)}&year=${year}&language=fr-FR`);
                const data = await response.json();
                return data.results && data.results.length > 0 ? data.results[0] : null;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des infos du film:', error);
                return null;
            }
        }

        // Fonction pour obtenir les services de streaming filtr√©s
        async function getFilteredStreamingProviders(movieId) {
            try {
                const response = await fetch(`${BASE_URL}/movie/${movieId}/watch/providers?api_key=${API_KEY}`);
                const data = await response.json();
                if (data.results && data.results.FR && data.results.FR.flatrate) {
                    return data.results.FR.flatrate
                        .filter(provider => {
                            // Filtrer Netflix sans publicit√©s
                            if (provider.provider_name.includes('Ads')) {
                                return false;
                            }
                            return selectedServices.includes(provider.provider_name) || 
                                   selectedServices.some(service => provider.provider_name.includes(service));
                        })
                        .map(provider => ({
                            name: provider.provider_name,
                            logo: provider.logo_path,
                            id: provider.provider_id
                        }));
                }
                return [];
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des plateformes:', error);
                return [];
            }
        }

        // Fonction pour obtenir les vid√©os (bandes-annonces)
        async function getMovieVideos(movieId) {
            try {
                const response = await fetch(`${BASE_URL}/movie/${movieId}/videos?api_key=${API_KEY}&language=fr-FR`);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const trailer = data.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                    return trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : null;
                }
                return null;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des vid√©os:', error);
                return null;
            }
        }

        // Fonction pour cr√©er l'ic√¥ne d'un service
        function createProviderIcon(provider) {
            const logoUrl = provider.logo ? `https://image.tmdb.org/t/p/w45${provider.logo}` : null;
            if (logoUrl) {
                return `<img src="${logoUrl}" alt="${provider.name}" class="provider-icon" title="${provider.name}">`;
            } else {
                const initials = provider.name.split(' ').map(word => word[0]).join('');
                return `<span class="provider-badge" title="${provider.name}">${initials}</span>`;
            }
        }

        // Fonction pour mettre √† jour les services s√©lectionn√©s
        function updateStreamingServices() {
            selectedServices = [];
            document.querySelectorAll('#streamingServicesConfig input[type="checkbox"]:checked').forEach(checkbox => {
                selectedServices.push(checkbox.value);
            });
            console.log('Services s√©lectionn√©s:', selectedServices);
        }

        // Fonction pour initialiser les contr√¥les d'affichage
        function initializeDisplayControls() {
            const filtersSection = document.getElementById('filtersSection');
            
            const displayControlsHTML = `
                <div class="display-controls">
                    <div class="view-toggle">
                        <button onclick="changeView('grid')" class="active" id="gridView">
                            <span>üî≤</span> Grille
                        </button>
                        <button onclick="changeView('list')" id="listView">
                            <span>üìã</span> Liste
                        </button>
                    </div>
                    
                    <div class="field-filters">
                        <span>Afficher :</span>
                        <label class="field-filter">
                            <input type="checkbox" checked onchange="toggleField('filename')"> 
                            üìÅ Nom de fichier
                        </label>
                        <label class="field-filter">
                            <input type="checkbox" checked onchange="toggleField('rating')"> 
                            ‚≠ê Note
                        </label>
                        <label class="field-filter">
                            <input type="checkbox" checked onchange="toggleField('year')"> 
                            üìÖ Ann√©e
                        </label>
                        <label class="field-filter">
                            <input type="checkbox" checked onchange="toggleField('providers')"> 
                            üì∫ Services
                        </label>
                    </div>
                </div>
            `;
            
            filtersSection.insertAdjacentHTML('afterbegin', displayControlsHTML);
            
            const ratingFilterHTML = `
                <div class="filter-group">
                    <label for="filterRating">Note (1-10)</label>
                    <div class="rating-range-container">
                        <div class="rating-range">
                            <div class="rating-range-fill" id="ratingRangeFill"></div>
                        </div>
                        <input type="range" id="ratingMin" class="rating-input" min="1" max="10" step="1" value="1" oninput="updateRatingRange()">
                        <input type="range" id="ratingMax" class="rating-input" min="1" max="10" step="1" value="10" oninput="updateRatingRange()">
                        <div class="rating-labels">
                            <span id="ratingMinLabel">1</span>
                            <span id="ratingMaxLabel">10</span>
                        </div>
                    </div>
                </div>
            `;
            
            const filtersGrid = document.querySelector('.filters-grid');
            filtersGrid.insertAdjacentHTML('beforeend', ratingFilterHTML);
            
            // Initialiser les valeurs par d√©faut
            ratingRange = { min: 1, max: 10 };
            updateRatingRange();
        }

        // Fonction pour changer le type d'affichage
        function changeView(view) {
            currentView = view;
            document.getElementById('gridView').classList.toggle('active', view === 'grid');
            document.getElementById('listView').classList.toggle('active', view === 'list');
            displayMovies();
        }

        // Fonction pour basculer l'affichage des champs
        function toggleField(field) {
            showFields[field] = !showFields[field];
            displayMovies();
        }

        // Fonction pour formater le temps restant
        function formatTimeRemaining(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.round(seconds % 60);
                return `${minutes}m ${remainingSeconds}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }
        }

        // Fonction pour mettre √† jour la barre de progression
        function updateProgress(current, total, currentFile, startTime, streamingCount = 0, nonStreamingCount = 0) {
            const percentage = Math.round((current / total) * 100);
            const elapsed = (Date.now() - startTime) / 1000;
            const rate = current / elapsed;
            const remaining = (total - current) / rate;
            
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            const currentFileEl = document.querySelector('.current-file');
            
            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressText) {
                progressText.innerHTML = `
                    <span>Analyse : ${current}/${total} fichiers</span>
                    <span class="progress-percentage">${percentage}%</span>
                `;
            }
            if (currentFileEl) {
                currentFileEl.textContent = `üìÅ ${currentFile}`;
            }
            
            const stats = document.querySelectorAll('.progress-stat-value');
            if (stats[0]) stats[0].textContent = current;
            if (stats[1]) stats[1].textContent = streamingCount;
            if (stats[2]) stats[2].textContent = nonStreamingCount;
        }

        // Fonction pour mettre √† jour le range de notes
        function updateRatingRange() {
            const minSlider = document.getElementById('ratingMin');
            const maxSlider = document.getElementById('ratingMax');
            const minLabel = document.getElementById('ratingMinLabel');
            const maxLabel = document.getElementById('ratingMaxLabel');
            const rangeFill = document.getElementById('ratingRangeFill');
            
            if (!minSlider || !maxSlider) return;
            
            let min = parseInt(minSlider.value);
            let max = parseInt(maxSlider.value);
            
            if (min > max) {
                if (minSlider === document.activeElement) {
                    max = min;
                    maxSlider.value = max;
                } else {
                    min = max;
                    minSlider.value = min;
                }
            }
            
            ratingRange = { min, max };
            
            if (minLabel) minLabel.textContent = min;
            if (maxLabel) maxLabel.textContent = max;
            
            if (rangeFill) {
                const minPercent = ((min - 1) / 9) * 100;
                const maxPercent = ((max - 1) / 9) * 100;
                rangeFill.style.left = `${minPercent}%`;
                rangeFill.style.width = `${maxPercent - minPercent}%`;
            }
            
            applyFilters();
        }

        // Fonction pour scanner les films avec barre de progression
        async function scanMovies() {
            const loadingEl = document.getElementById('loading');
            const scanBtn = document.querySelector('.scan-button');
            const moviesGrid = document.getElementById('moviesGrid');
            const statsEl = document.getElementById('stats');
            const filtersEl = document.getElementById('filtersSection');
            
            loadingEl.innerHTML = `
                <div class="progress-container">
                    <div class="progress-text">
                        <span>Pr√©paration de l'analyse...</span>
                        <span class="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="current-file">Initialisation...</div>
                    <div class="progress-stats">
                        <div class="progress-stat">
                            <div class="progress-stat-value">0</div>
                            <div class="progress-stat-label">Analys√©s</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value">0</div>
                            <div class="progress-stat-label">Streaming</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value">0</div>
                            <div class="progress-stat-label">Non dispo</div>
                        </div>
                    </div>
                </div>
            `;
            
            loadingEl.style.display = 'block';
            scanBtn.disabled = true;
            moviesGrid.innerHTML = '';
            statsEl.style.display = 'none';
            filtersEl.style.display = 'none';
            moviesData = [];
            allMoviesData = [];
            allGenres = [];

            const filesToScan = scanLocalDirectory();
            const totalFiles = filesToScan.length;
            let processedFiles = 0;
            let totalMovies = 0;
            let streamingMovies = 0;
            let nonStreamingMovies = 0;
            
            const startTime = Date.now();

            for (let i = 0; i < filesToScan.length; i++) {
                const filename = filesToScan[i];
                
                updateProgress(processedFiles, totalFiles, filename, startTime, streamingMovies, nonStreamingMovies);
                
                const { movieName, year } = detectMovieInfo(filename);
                
                if (movieName && year) {
                    try {
                        const movieInfo = await getMovieInfo(movieName, year);
                        if (movieInfo) {
                            const providers = await getFilteredStreamingProviders(movieInfo.id);
                            const movieData = {
                                ...movieInfo,
                                filename,
                                streamingProviders: providers,
                                hasStreaming: providers.length > 0
                            };
                            allMoviesData.push(movieData);
                            
                            // Collecter les genres
                            if (movieInfo.genre_ids && movieInfo.genre_ids.length > 0) {
                                movieInfo.genre_ids.forEach(genreId => {
                                    if (!allGenres.some(g => g.id === genreId)) {
                                        allGenres.push({ id: genreId });
                                    }
                                });
                            }
                            
                            if (movieData.hasStreaming) {
                                streamingMovies++;
                            } else {
                                nonStreamingMovies++;
                            }
                            totalMovies++;
                        }
                    } catch (error) {
                        console.error(`Erreur lors du traitement de ${filename}:`, error);
                    }
                }
                
                processedFiles++;
                updateProgress(processedFiles, totalFiles, filename, startTime, streamingMovies, nonStreamingMovies);
                await new Promise(resolve => setTimeout(resolve, 250));
            }

            updateProgress(totalFiles, totalFiles, 'Analyse termin√©e !', startTime, streamingMovies, nonStreamingMovies);
            await new Promise(resolve => setTimeout(resolve, 1000));

            loadingEl.style.display = 'none';
            scanBtn.disabled = false;
            
            document.getElementById('totalMovies').textContent = totalMovies;
            document.getElementById('streamingMovies').textContent = streamingMovies;
            document.getElementById('nonStreamingMovies').textContent = nonStreamingMovies;
            statsEl.style.display = 'block';
            filtersEl.style.display = 'block';
            
            initializeDisplayControls();
            await updateGenreFilter();
            updateProviderFilter();
            applyFilters();
        }

        // Fonction pour mettre √† jour le filtre des genres
        async function updateGenreFilter() {
            try {
                const response = await fetch(`${BASE_URL}/genre/movie/list?api_key=${API_KEY}&language=fr-FR`);
                const data = await response.json();
                
                const genreFilter = document.getElementById('filterGenre');
                const movieGenres = new Set();
                
                allMoviesData.forEach(movie => {
                    if (movie.genre_ids) {
                        movie.genre_ids.forEach(genreId => movieGenres.add(genreId));
                    }
                });
                
                const availableGenres = data.genres.filter(genre => movieGenres.has(genre.id));
                
                genreFilter.innerHTML = `
                    <option value="">Tous les genres</option>
                    ${availableGenres.map(genre => 
                        `<option value="${genre.id}">${genre.name}</option>`
                    ).join('')}
                `;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des genres:', error);
            }
        }

        // Fonction pour mettre √† jour le filtre des services
        function updateProviderFilter() {
            const providerFilter = document.getElementById('filterProvider');
            const allProviders = new Set();
            
            allMoviesData.forEach(movie => {
                movie.streamingProviders.forEach(provider => {
                    allProviders.add(provider.name);
                });
            });
            
            providerFilter.innerHTML = `
                <option value="">Tous les services</option>
                ${Array.from(allProviders).sort().map(provider => 
                    `<option value="${provider}">${provider}</option>`
                ).join('')}
                <option value="none">Aucun service</option>
            `;
        }

        // Fonction pour appliquer tous les filtres et tris
        function applyFilters() {
            const showStreaming = document.getElementById('showStreaming').checked;
            const showNonStreaming = document.getElementById('showNonStreaming').checked;
            const sortBy = document.getElementById('sortBy').value;
            const filterProvider = document.getElementById('filterProvider').value;
            const filterGenre = document.getElementById('filterGenre').value;
            
            moviesData = allMoviesData.filter(movie => {
                let showByStreaming = false;
                if (showStreaming && movie.hasStreaming) showByStreaming = true;
                if (showNonStreaming && !movie.hasStreaming) showByStreaming = true;
                if (!showByStreaming) return false;
                
                if (filterProvider) {
                    if (filterProvider === 'none' && movie.hasStreaming) return false;
                    if (filterProvider !== 'none' && !movie.streamingProviders.some(p => p.name === filterProvider)) return false;
                }
                
                if (filterGenre && movie.genre_ids && !movie.genre_ids.includes(parseInt(filterGenre))) {
                    return false;
                }
                
                if (movie.vote_average < ratingRange.min || movie.vote_average > ratingRange.max) return false;
                
                return true;
            });
            
            moviesData.sort((a, b) => {
                const [field, direction] = sortBy.includes('-desc') ? [sortBy.replace('-desc', ''), 'desc'] : [sortBy, 'asc'];
                let valueA, valueB;
                switch (field) {
                    case 'title':
                        valueA = a.title.toLowerCase();
                        valueB = b.title.toLowerCase();
                        break;
                    case 'release_date':
                        valueA = new Date(a.release_date);
                        valueB = new Date(b.release_date);
                        break;
                    case 'vote_average':
                        valueA = a.vote_average;
                        valueB = b.vote_average;
                        break;
                    default:
                        return 0;
                }
                if (direction === 'desc') {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                } else {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                }
            });

            displayMovies();
        }

        // Fonction pour afficher les films selon le type d'affichage
        function displayMovies() {
            const moviesGrid = document.getElementById('moviesGrid');
            
            if (currentView === 'list') {
                moviesGrid.className = 'movies-list';
            } else {
                moviesGrid.className = 'movies-grid';
            }
            
            moviesGrid.innerHTML = '';

            if (moviesData.length === 0) {
                moviesGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d; font-size: 1.2rem;">
                        ${allMoviesData.length === 0 ?
                            'Aucun film analys√©. Cliquez sur "Scanner la biblioth√®que" pour commencer.' :
                            'Aucun film ne correspond aux crit√®res s√©lectionn√©s.'
                        }
                    </div>
                `;
                return;
            }

            moviesData.forEach(movie => {
                const movieCard = currentView === 'list' ? createMovieCardList(movie) : createMovieCard(movie);
                moviesGrid.appendChild(movieCard);
            });
        }

        // Fonction pour cr√©er une carte de film en grille
        function createMovieCard(movie) {
            const card = document.createElement('div');
            card.className = 'movie-card';
            card.onclick = () => showMovieDetails(movie.id);
            
            const posterUrl = movie.poster_path ? `${IMAGE_BASE_URL}${movie.poster_path}` : '';
            
            card.innerHTML = `
                <div class="movie-poster">
                    ${posterUrl ? `<img src="${posterUrl}" alt="${movie.title}">` : '<div class="no-poster">Pas d\'affiche</div>'}
                    <div class="movie-overlay">
                        <div class="movie-title">${movie.title}</div>
                        ${showFields.filename ? `
                            <div class="movie-filename">
                                <span>üìÅ</span> ${movie.filename}
                            </div>
                        ` : ''}
                        <div class="movie-rating">
                            ${showFields.year ? `<span>${new Date(movie.release_date).getFullYear()}</span>` : ''}
                            ${showFields.rating ? `<span class="rating-badge">‚≠ê ${movie.vote_average.toFixed(1)}</span>` : ''}
                        </div>
                        ${showFields.providers ? `
                            <div class="streaming-providers">
                                ${movie.hasStreaming ?
                                    movie.streamingProviders.map(provider => createProviderIcon(provider)).join('') :
                                    '<span class="no-streaming">‚ùå Non disponible</span>'
                                }
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        // Fonction pour cr√©er une carte de film en liste
        function createMovieCardList(movie) {
            const card = document.createElement('div');
            card.className = 'movie-card-list';
            card.onclick = () => showMovieDetails(movie.id);
            
            const posterUrl = movie.poster_path ? `${IMAGE_BASE_URL}${movie.poster_path}` : '';
            
            card.innerHTML = `
                <div class="movie-poster-list">
                    ${posterUrl ? `<img src="${posterUrl}" alt="${movie.title}">` : '<div class="no-poster">Pas d\'affiche</div>'}
                </div>
                <div class="movie-info-list">
                    <div class="movie-header-list">
                        <div class="movie-title-list">${movie.title}</div>
                        ${showFields.filename ? `
                            <div class="movie-filename-list">
                                <span>üìÅ</span> ${movie.filename}
                            </div>
                        ` : ''}
                    </div>
                    <div class="movie-details-list">
                        ${showFields.year ? `<span class="movie-year-list">${new Date(movie.release_date).getFullYear()}</span>` : ''}
                        ${showFields.rating ? `<span class="rating-badge-list">‚≠ê ${movie.vote_average.toFixed(1)}</span>` : ''}
                        ${showFields.providers ? `
                            <div class="streaming-providers">
                                ${movie.hasStreaming ?
                                    movie.streamingProviders.map(provider => createProviderIcon(provider)).join('') :
                                    '<span class="no-streaming">‚ùå Non disponible</span>'
                                }
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        // Fonction pour afficher les d√©tails du film
        async function showMovieDetails(movieId) {
            const movie = allMoviesData.find(m => m.id === movieId);
            if (!movie) return;

            try {
                const [detailsResponse, trailerUrl] = await Promise.all([
                    fetch(`${BASE_URL}/movie/${movieId}?api_key=${API_KEY}&language=fr-FR`),
                    getMovieVideos(movieId)
                ]);
                
                const detailedMovie = await detailsResponse.json();
                const modal = document.getElementById('movieModal');
                const posterUrl = detailedMovie.poster_path ? `${IMAGE_BASE_URL}${detailedMovie.poster_path}` : '';
                
                document.getElementById('modalPoster').src = posterUrl;
                document.getElementById('modalTitle').textContent = detailedMovie.title;
                document.getElementById('modalOverview').textContent = detailedMovie.overview || 'Aucun synopsis disponible.';

                const providersHtml = movie.hasStreaming ?
                    movie.streamingProviders.map(provider => createProviderIcon(provider)).join('') :
                    '<span class="no-streaming">‚ùå Non disponible en streaming</span>';
                document.getElementById('modalProviders').innerHTML = providersHtml;

                const detailsHtml = `
                    <div class="detail-item">
                        <div class="detail-label">Nom du fichier</div>
                        <div class="detail-value">üìÅ ${movie.filename}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Date de sortie</div>
                        <div class="detail-value">${new Date(detailedMovie.release_date).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Dur√©e</div>
                        <div class="detail-value">${detailedMovie.runtime || 'N/A'} min</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Note TMDB</div>
                        <div class="detail-value">‚≠ê ${detailedMovie.vote_average.toFixed(1)}/10</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Genres</div>
                        <div class="detail-value">${detailedMovie.genres.map(g => g.name).join(', ')}</div>
                    </div>
                `;
                document.getElementById('modalDetails').innerHTML = detailsHtml;

                const linksHtml = `
                    <div class="modal-links">
                        <a href="https://www.themoviedb.org/movie/${movieId}" target="_blank" class="modal-link tmdb-link">
                            <span>üé¨</span> Voir sur TMDB
                        </a>
                        ${trailerUrl ? `
                            <a href="${trailerUrl}" target="_blank" class="modal-link trailer-link">
                                <span>üé•</span> Bande-annonce
                            </a>
                        ` : ''}
                    </div>
                `;
                
                const existingLinks = document.querySelector('.modal-links');
                if (existingLinks) {
                    existingLinks.remove();
                }
                document.getElementById('modalDetails').insertAdjacentHTML('afterend', linksHtml);

                modal.style.display = 'block';
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des d√©tails:', error);
            }
        }

        // Fonction pour fermer la modal
        function closeModal() {
            document.getElementById('movieModal').style.display = 'none';
        }

        // Fermer la modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('movieModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>